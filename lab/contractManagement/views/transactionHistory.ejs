<!DOCTYPE html>
<html>

<head>
  <title>Contract Management</title>
  <style>
    tr:hover {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <%- include('../Components/navbar.ejs') %>

  <div class="d-flex" id="wrapper">
    <%- include('../Components/sideBar.ejs') %>
    <div id="page-content-wrapper">
      <h2>Bảng kê thu/chi</h2>
      <button class="btn btn-sm btn-primary" id="export">Export Excel</button>
      <table class="table table-striped table-hover table1">
        <thead>
          <tr>
            <th id="storeId">Mã PGD</th>
            <th id="storeName">Tên PGD</th>
            <th id="date">Ngày đóng</th>
            <th id="id">Số phiếu</th>
            <th id="contractId">Số hợp đồng</th>
            <th id="customerId">Mã KH</th>
            <th id="customerName">Tên KH</th>
            <th id="receiptReason">Nội dung giao dịch</th>
            <th id="paid1">Thu</th>
            <th id="paid2">Chi</th>
            <th id="type">Loại tiền</th>
            <th id="receiptId">Mã thu chi</th>
            <th id="note">Ghi chú</th>
            <th id="employeeId">Mã NV thẩm định</th>
            <th id="employeeName">Tên NV thẩm định</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


  <script>
    const loanPackage = JSON.parse('<%- JSON.stringify(loanPackage) %>')
    console.log('loan package array: ', loanPackage)
    const contract = JSON.parse('<%- JSON.stringify(contract) %>')
    console.log('contract: ', contract)


    if (loanPackage.length !== 0) {
      loanPackage.forEach(loan => {
        if (loan) {
          var tr = document.createElement('tr')
          tr.id = loan.contract_Id
          document.querySelectorAll('table thead th').forEach(element => {
            var th = document.createElement('th')
            switch (element.id) {
              case ('paid1'):
                th.innerHTML = loan.receiptType === 1 ? (loan.paid ? loan.paid.toLocaleString() : '-') : ('-')
                break;
              case ('paid2'):
                th.innerHTML = loan.receiptType === 2 ? (loan.paid ? loan.paid.toLocaleString() : '-') : ('-')
                break;
              default:
                th.innerHTML = loan[element.id] ? loan[element.id].toLocaleString() : '-'
                break;
            }

            tr.appendChild(th)
          })
          tr.addEventListener('click', (event) => {
            console.log('event: ', event.target.closest('tr'))
            window.location.href = `/contractMng/contracts/${event.target.closest('tr').id}/checkTable?token=${window.localStorage.getItem('accessToken')}`
          })
          document.querySelector('table tbody').appendChild(tr)
        }
      });
    }
  </script>

  <script type="module">
    import { exportHTMLTableToExcel } from '/exportHTMLTableToExcel.js'
    document.querySelector('button#export').addEventListener('click', event => {
      exportHTMLTableToExcel(['table1'],
        `Bảng_kê_thu_chi_${new Date(Date.now()).toLocaleDateString()}`)
    })

  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet"
    href="https://unpkg.com/bootstrap-material-design@4.1.1/dist/css/bootstrap-material-design.min.css">
  <style>

  </style>
</head>

<body>
  <%- include('../Components/navbar.ejs') %>
  <div class="d-flex" id="wrapper">
    <%- include('../Components/sideBar.ejs') %>
    <div id="page-content-wrapper">
      <h1>BẢNG TÍNH LÃI THEO DƯ NỢ CỐ ĐỊNH</h1>
      <h4>Tao goi vay</h4>
      <div class="container loan-package">
        <div class="row">
          <div class="col d-flex">
            <div class="form-group">
              <label>So tien vay</label>
              <input type="number" class="form-control" id="presentValue">
            </div>
            <div class="form-group">
              <label>Ngay bat dau goi vay</label>
              <input type="date" class="form-control" id="agreementDate">
            </div>
          </div>

        </div>
        <div class="row">
          <div class="col d-flex">
            <div class="form-group">
              <label>Lai suat ngay</label>
              <input type="number" class="form-control" id="interestRatePerDay">
            </div>
            <div class="form-group">
              <label>So lan tra theo thang</label>
              <input type="number" class="form-control" id="numberOfPayments">
            </div>
          </div>
        </div>
        <button class="btn btn-sm btn-primary" id="createLoanPackage">Kich hoat goi vay</button>

      </div>


      <h4>Bang chi tiet</h4>
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th scope="col" id="times">So lan dong lai</th>
            <th scope="col" id="redemptionDate">Ngay dong lai(dd/mm/yyyy)</th>
            <th scope="col" id="redemption">Redemption</th>
            <th scope="col" id="principal">Principal</th>
            <th scope="col" id="incrementalPayedPrincipal">Goc da tra cong don</th>
            <th scope="col" id="interest">Interest</th>
            <th scope="col" id="accumulatedPayedInterest">Lai da tra luy ke</th>
            <th scope="col" id="remainedPrincipal">Tien goc con lai</th>

          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>


  <script>
    createLoanPackage.addEventListener('click', (event) => {
      console.log('event: ', event.target)
      var obj = {}
      event.target.closest('.container').querySelectorAll('input').forEach(input => {
        if (input.type === 'number') {
          obj[input.id] = parseFloat(input.value)
        } else {
          obj[input.id] = input.value
        }
      });
      calculateRedemption(obj)

    })
  </script>

  <script>
    function displayDept(times, redemptionDate, redemption, principal,
      incrementalPayedPrincipal, interest, accumulatedPayedInterest, remainedPrincipal) {
      var tr = document.createElement('tr')
      for (var i = 0; i < arguments.length; i++) {
        var th = document.createElement('th')
        th.innerHTML = arguments[i]
        tr.appendChild(th)
      }
      document.querySelector('table').querySelector('tbody').appendChild(tr)
    }
  </script>

  <script>
    const getDateAfterAnAmountOfDates = (date, amount) => {
      return formatDate(new Date(date.setDate(date.getDate() + amount)))
    }

    const getDateAfterAnAmountOfMonths = (originalDate, amount) => {
      var date = new Date(originalDate)
      var redemptionDate = new Date(date.setMonth(date.getMonth() + amount))
      const oneDay = 24 * 60 * 60 * 1000
      var daysInMonth = Math.abs((redemptionDate - originalDate) / oneDay)
      return {
        redemptionDate, daysInMonth
      }
    }

    const formatDate = (date) => {
      var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

      if (month.length < 2)
        month = '0' + month;
      if (day.length < 2)
        day = '0' + day;

      return [day, month, year].join('-');
    }

    function pmt(rate_per_period, number_of_payments, present_value, future_value, type) {
      future_value = typeof future_value !== 'undefined' ? future_value : 0;
      type = typeof type !== 'undefined' ? type : 0;

      if (rate_per_period != 0.0) {
        // Interest rate exists
        var q = Math.pow(1 + rate_per_period, number_of_payments);
        return -(rate_per_period * (future_value + (q * present_value))) / ((-1 + q) * (1 + rate_per_period * (type)));

      } else if (number_of_payments != 0.0) {
        // No interest rate, but number of payments exists
        return -(future_value + present_value) / number_of_payments;
      }

      return 0;
    }

  </script>

  <script>

    // redemption, principal, incrementalPayedPrincipal, interest, accumulatedPayedInterest, remainedPrincipal
    // tien tra theo ky, tien goc, goc da tra cong don, lai, lai da tra luy ke, goc con lai

    const calculateRedemption = (package) => {
      console.log('package: ', package)
      var presentValue = package.presentValue,
        numberOfPayments = package.numberOfPayments,
        interestRatePerDay = package.interestRatePerDay,
        interest = 0,
        redemption = 0,
        principal = presentValue / numberOfPayments,
        incrementalPayedPrincipal = 0,
        accumulatedPayedInterest = 0,
        remainedPrincipal = 0

      document.querySelector('table').querySelector('tbody').innerHTML = ''
      var termArray = []

      for (var i = 1; i <= numberOfPayments; i++) {
        var agreementDate = new Date(package.agreementDate)
        var { redemptionDate, daysInMonth } = getDateAfterAnAmountOfMonths(termArray.length === 0 ?
          agreementDate : termArray[termArray.length - 1], 1)
        termArray.push(redemptionDate)
        console.log('redemption date: ', formatDate(redemptionDate), ', days in month: ', daysInMonth)
        redemption = pmt((interestRatePerDay * daysInMonth) / 100, numberOfPayments, -presentValue)
        interest = ((interestRatePerDay * daysInMonth) * (presentValue - incrementalPayedPrincipal)) / 100
        principal = redemption - interest
        incrementalPayedPrincipal += principal
        accumulatedPayedInterest += interest
        remainedPrincipal = presentValue - incrementalPayedPrincipal

        displayDept(i, formatDate(redemptionDate), Math.round(redemption, -1), Math.round(principal, -1), Math.round(incrementalPayedPrincipal, -1),
          Math.round(interest, -1), Math.round(accumulatedPayedInterest, -1), Math.round(remainedPrincipal, -1))
      }
    }
  </script>
</body>

</html>